{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://pwf.dev/schema/v2/plan.json",
  "title": "PWF Plan v2",
  "description": "Portable Workout Format v2 schema with exercise library support",
  "type": "object",
  "required": ["plan_version", "cycle"],
  "additionalProperties": false,
  "properties": {
    "plan_version": {
      "type": "integer",
      "const": 2,
      "description": "Specification version (must be 2)"
    },
    "meta": {
      "$ref": "pwf-v1.json#/$defs/Meta"
    },
    "glossary": {
      "type": "object",
      "description": "Term definitions for exercises and concepts used in this plan",
      "maxProperties": 100,
      "additionalProperties": {
        "type": "string",
        "minLength": 1,
        "maxLength": 500
      },
      "propertyNames": {
        "pattern": "^[a-zA-Z0-9\\s\\-']+$",
        "minLength": 1,
        "maxLength": 50
      }
    },
    "exercise_library": {
      "type": "array",
      "maxItems": 500,
      "items": {
        "$ref": "#/$defs/LibraryExercise"
      },
      "description": "Exercise library for reusable exercise definitions"
    },
    "workout_templates": {
      "type": "array",
      "maxItems": 100,
      "items": {
        "$ref": "#/$defs/WorkoutTemplate"
      },
      "description": "Workout templates for reusable exercise groups"
    },
    "cycle": {
      "$ref": "#/$defs/Cycle"
    }
  },
  "$defs": {
    "LibraryExercise": {
      "type": "object",
      "description": "Reusable exercise definition in the library",
      "additionalProperties": false,
      "required": ["id", "name", "modality"],
      "properties": {
        "id": {
          "type": "string",
          "minLength": 1,
          "maxLength": 100,
          "pattern": "^[a-zA-Z0-9_-]+$",
          "description": "Unique library exercise identifier (alphanumeric, hyphens, underscores)"
        },
        "name": {
          "type": "string",
          "minLength": 1,
          "maxLength": 100,
          "description": "Exercise display name"
        },
        "description": {
          "type": "string",
          "maxLength": 500,
          "description": "Detailed exercise description"
        },
        "equipment": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Required equipment"
        },
        "muscle_groups": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Targeted muscle groups"
        },
        "difficulty": {
          "type": "string",
          "enum": ["beginner", "intermediate", "advanced"],
          "description": "Exercise difficulty level"
        },
        "modality": {
          "type": "string",
          "enum": ["strength", "countdown", "stopwatch", "interval", "cycling", "running", "rowing", "swimming"],
          "description": "Exercise type"
        },
        "default_sets": {
          "type": "integer",
          "minimum": 1,
          "description": "Default number of sets"
        },
        "default_reps": {
          "type": "integer",
          "minimum": 1,
          "description": "Default reps per set"
        },
        "default_duration_sec": {
          "type": "integer",
          "minimum": 1,
          "description": "Default duration in seconds"
        },
        "default_distance_meters": {
          "type": "number",
          "minimum": 0,
          "description": "Default distance in meters"
        },
        "cues": {
          "type": "string",
          "description": "Form cues and coaching points"
        },
        "link": {
          "type": "string",
          "format": "uri",
          "pattern": "^https://",
          "description": "Tutorial URL (HTTPS only)"
        },
        "image": {
          "type": "string",
          "format": "uri",
          "pattern": "^https://",
          "description": "Demo image URL (HTTPS only)"
        }
      }
    },
    "WorkoutTemplate": {
      "type": "object",
      "description": "Reusable workout template definition",
      "additionalProperties": false,
      "required": ["id", "name", "exercises"],
      "properties": {
        "id": {
          "type": "string",
          "minLength": 1,
          "maxLength": 100,
          "pattern": "^[a-zA-Z0-9_-]+$",
          "description": "Unique template identifier (alphanumeric, hyphens, underscores)"
        },
        "name": {
          "type": "string",
          "minLength": 1,
          "maxLength": 100,
          "description": "Template display name"
        },
        "description": {
          "type": "string",
          "maxLength": 500,
          "description": "Detailed template description"
        },
        "focus": {
          "type": "string",
          "description": "Training focus or theme"
        },
        "target_session_length_min": {
          "type": "integer",
          "minimum": 1,
          "description": "Expected duration in minutes"
        },
        "tags": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Template categorization tags"
        },
        "exercises": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/$defs/Exercise"
          },
          "description": "Exercises in this template"
        }
      }
    },
    "Cycle": {
      "type": "object",
      "description": "Training cycle containing workout days",
      "additionalProperties": false,
      "required": ["days"],
      "properties": {
        "start_date": {
          "type": "string",
          "format": "date",
          "pattern": "^\\d{4}-\\d{2}-\\d{2}$",
          "description": "ISO 8601 date (YYYY-MM-DD)"
        },
        "notes": {
          "type": "string",
          "description": "Cycle-level coaching notes"
        },
        "days": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/$defs/Day"
          },
          "description": "Training days in this cycle"
        }
      }
    },
    "Day": {
      "type": "object",
      "description": "Single training day",
      "additionalProperties": false,
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique day identifier"
        },
        "order": {
          "type": "integer",
          "minimum": 0,
          "description": "Day sequence (0-indexed)"
        },
        "focus": {
          "type": "string",
          "description": "Training focus or theme"
        },
        "notes": {
          "type": "string",
          "description": "Day-level coaching notes"
        },
        "scheduled_date": {
          "type": "string",
          "format": "date",
          "pattern": "^\\d{4}-\\d{2}-\\d{2}$",
          "description": "Planned workout date"
        },
        "target_session_length_min": {
          "type": "integer",
          "minimum": 1,
          "description": "Expected duration in minutes"
        },
        "template_ref": {
          "type": "string",
          "minLength": 1,
          "maxLength": 100,
          "pattern": "^[a-zA-Z0-9_-]+$",
          "description": "Reference to a workout template (v2 only)"
        },
        "exercises": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/Exercise"
          },
          "description": "Exercises in this day (optional if template_ref is specified)"
        }
      }
    },
    "Exercise": {
      "type": "object",
      "description": "Single exercise definition (v2: modality OR exercise_ref required)",
      "additionalProperties": false,
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique exercise identifier"
        },
        "name": {
          "type": "string",
          "description": "Exercise name (optional if using exercise_ref)"
        },
        "exercise_ref": {
          "type": "string",
          "description": "Reference to library exercise ID"
        },
        "modality": {
          "type": "string",
          "enum": ["strength", "countdown", "stopwatch", "interval", "cycling", "running", "rowing", "swimming"],
          "description": "Exercise type (optional if using exercise_ref)"
        },
        "target_sets": {
          "type": "integer",
          "minimum": 1,
          "description": "Target number of sets"
        },
        "target_reps": {
          "type": "integer",
          "minimum": 1,
          "description": "Target reps per set"
        },
        "target_duration_sec": {
          "type": "integer",
          "minimum": 1,
          "description": "Target duration in seconds"
        },
        "target_distance_meters": {
          "type": "number",
          "minimum": 0,
          "description": "Target distance in meters"
        },
        "target_load": {
          "type": "string",
          "description": "Loading guidance (weight, RPE, %1RM)"
        },
        "target_weight_percent": {
          "type": "number",
          "minimum": 0,
          "maximum": 200,
          "description": "Target weight as percentage of reference max (requires percent_of)"
        },
        "percent_of": {
          "type": "string",
          "enum": ["1rm", "3rm", "5rm", "10rm"],
          "description": "Reference max for percentage calculation (requires target_weight_percent)"
        },
        "reference_exercise": {
          "type": "string",
          "description": "Reference another exercise's max for percentage calculation"
        },
        "cues": {
          "type": "string",
          "description": "Form cues (overrides library if using exercise_ref)"
        },
        "target_notes": {
          "type": "string",
          "description": "Coaching notes for this exercise"
        },
        "link": {
          "type": "string",
          "format": "uri",
          "pattern": "^https://",
          "description": "Tutorial URL (HTTPS only)"
        },
        "image": {
          "type": "string",
          "format": "uri",
          "pattern": "^https://",
          "description": "Demo image URL (HTTPS only)"
        },
        "group": {
          "type": "string",
          "minLength": 1,
          "maxLength": 50,
          "pattern": "^[a-zA-Z0-9_-]+$",
          "description": "Group identifier for supersets/circuits"
        },
        "group_type": {
          "type": "string",
          "enum": ["superset", "circuit"],
          "description": "Type of exercise grouping"
        },
        "rest_between_sets_sec": {
          "type": "integer",
          "minimum": 0,
          "description": "Rest period in seconds between sets"
        },
        "rest_after_sec": {
          "type": "integer",
          "minimum": 0,
          "description": "Rest period in seconds after completing all sets"
        },
        "progression_rules": {
          "$ref": "#/$defs/ProgressionRules"
        }
      },
      "oneOf": [
        {"required": ["modality"]},
        {"required": ["exercise_ref"]}
      ]
    },
    "ProgressionRules": {
      "type": "object",
      "description": "Automatic progressive overload rules",
      "additionalProperties": false,
      "required": ["type", "success_condition"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["linear", "double_progression"],
          "description": "Progression strategy type"
        },
        "success_condition": {
          "type": "string",
          "enum": ["all_sets_completed", "last_set_completed", "average_reps_reached"],
          "description": "Condition that triggers progression"
        },
        "weight_increment_kg": {
          "type": "number",
          "minimum": 0,
          "exclusiveMinimum": true,
          "description": "Weight increment in kilograms (cannot use with weight_increment_lbs)"
        },
        "weight_increment_lbs": {
          "type": "number",
          "minimum": 0,
          "exclusiveMinimum": true,
          "description": "Weight increment in pounds (cannot use with weight_increment_kg)"
        },
        "reps_increment": {
          "type": "integer",
          "minimum": 1,
          "description": "Number of reps to increase per progression"
        },
        "reps_range_min": {
          "type": "integer",
          "minimum": 1,
          "description": "Minimum reps in double progression range"
        },
        "reps_range_max": {
          "type": "integer",
          "minimum": 1,
          "description": "Maximum reps in double progression range"
        },
        "deload_condition": {
          "type": "string",
          "enum": ["failed_once_consecutive", "failed_twice_consecutive", "failed_three_consecutive", "rir_above_target"],
          "description": "Condition that triggers a deload"
        },
        "deload_percent": {
          "type": "number",
          "minimum": 50,
          "maximum": 100,
          "description": "Percentage of current weight to deload to (e.g., 90 = 90%)"
        },
        "deload_weeks": {
          "type": "integer",
          "minimum": 1,
          "description": "Number of weeks to maintain deload weight"
        },
        "max_weight_kg": {
          "type": "number",
          "minimum": 0,
          "exclusiveMinimum": true,
          "description": "Maximum weight ceiling in kilograms (cannot use with max_weight_lbs)"
        },
        "max_weight_lbs": {
          "type": "number",
          "minimum": 0,
          "exclusiveMinimum": true,
          "description": "Maximum weight ceiling in pounds (cannot use with max_weight_kg)"
        },
        "notes": {
          "type": "string",
          "description": "Additional notes about progression strategy"
        }
      }
    }
  }
}
